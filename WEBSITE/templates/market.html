{% extends "base.html" %}
{% block title %}Market{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Market</h2>

    <div class="card">
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="market-table">
                <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Ticker</th>
                        <th>Current Price</th>
                        <th>Opening Price</th>
                        <th>High (Today)</th>
                        <th>Low (Today)</th>
                        <th>Quantity</th>
                        <th>Market Cap</th>
                        <th>Buy</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in stocks %}
                    <tr id="stock-{{ stock.ticker }}">
                        <td>{{ stock.name }}</td>
                        <td>{{ stock.ticker }}</td>
                        <td class="current-price">${{ "%.2f"|format(stock.current_price) }}</td>
                        <td class="open-price">${{ "%.2f"|format(stock.open_price) }}</td>
                        <td class="high-price">${{ "%.2f"|format(stock.high_price) }}</td>
                        <td class="low-price">${{ "%.2f"|format(stock.low_price) }}</td>
                        <td class="quantity">{{ stock.quantity }}</td>
                        <td class="market-cap">${{ "%.2f"|format(stock.market_cap) }}</td>
                        <td>
                            {% if stock.quantity > 0 %}
                            <form method="POST" action="{{ url_for('order_preview', ticker=stock.ticker) }}" class="d-flex gap-2">
                                <input type="hidden" name="action" value="BUY">
                                <input type="number" name="quantity" class="form-control form-control-sm" min="1" max="{{ stock.quantity }}" placeholder="Qty" required style="width: 80px;">
                                <button type="submit" class="btn btn-success btn-sm">Buy</button>
                            </form>
                            {% else %}
                            <span class="badge bg-danger">Out of Stock</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
async function fetchMarketData() {
    try {
        const response = await fetch('/market_demo_data');
        const data = await response.json();

        data.forEach(stock => {
            const row = document.getElementById('stock-' + stock.ticker);
            if (!row) return;

            const current = parseFloat(stock.current_price) || 0;
            const open = parseFloat(stock.open_price) || 0;
            const high = parseFloat(stock.high_price) || 0;
            const low = parseFloat(stock.low_price) || 0;
            const quantity = parseInt(stock.quantity) || 0;
            const marketCap = parseFloat(stock.market_cap) || 0;

            row.querySelector('.current-price').textContent = `$${current.toFixed(2)}`;
            row.querySelector('.open-price').textContent = `$${open.toFixed(2)}`;
            row.querySelector('.high-price').textContent = `$${high.toFixed(2)}`;
            row.querySelector('.low-price').textContent = `$${low.toFixed(2)}`;
            row.querySelector('.quantity').textContent = quantity;
            row.querySelector('.market-cap').textContent = `$${marketCap.toFixed(2)}`;
        });
    } catch (err) {
        console.error('Error fetching market data:', err);
    }
}

// Update every second
setInterval(fetchMarketData, 1000);
</script>
{% endblock %}
